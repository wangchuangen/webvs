<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.wang.chuangen.webvs.dao.ResourceDao">
	<resultMap id="resource" type="org.wang.chuangen.webvs.model.Resource">
		<id column="ID" property="id"/>
		<result column="PARENT_ID" property="parentId"/>
		<result column="URL" property="url"/>
		<result column="URL_TYPE" property="urlType"/>
		<result column="FILE_NAME" property="fileName"/>
		<result column="LABEL" property="label"/>
		<result column="VERSION_NUMBER" property="versionNumber"/>
		<result column="UPDATE_TIME" property="updateTime"/>
	</resultMap>
	
	<resultMap id="resource_tree" type="org.wang.chuangen.webvs.model.Resource">
		<id column="ID" property="id"/>
		<result column="PARENT_ID" property="parentId"/>
		<result column="URL" property="url"/>
		<result column="URL_TYPE" property="urlType"/>
		<result column="FILE_NAME" property="fileName"/>
		<result column="LABEL" property="label"/>
		<result column="VERSION_NUMBER" property="versionNumber"/>
		<result column="UPDATE_TIME" property="updateTime"/>
		<collection column="ID" property="children" javaType="ArrayList" select="findSonResource"></collection>
	</resultMap>
	
	<insert id="addResource" useGeneratedKeys="true" keyColumn="ID" keyProperty="id" parameterType="org.wang.chuangen.webvs.model.Resource">
		INSERT INTO RESOURCE(PARENT_ID,URL,URL_TYPE,FILE_NAME,LABEL,VERSION_NUMBER,UPDATE_TIME)
		VALUES(#{parentId},#{url},#{urlType},#{fileName},#{label},#{versionNumber},#{updateTime})
	</insert>
	
	<insert id="addResources" parameterType="List">
		INSERT INTO RESOURCE(PARENT_ID,URL,URL_TYPE,FILE_NAME,LABEL,VERSION_NUMBER,UPDATE_TIME)
		<foreach collection="list" item="resource" open="VALUES(" separator="),(" close=")">#{resource.parentId},#{resource.url},#{resource.urlType},#{resource.fileName},#{resource.label},#{resource.versionNumber},#{resource.updateTime}</foreach>
	</insert>
	
	<insert id="addResourceRelies" parameterType="List">
		INSERT INTO RESOURCE_RELY(ID,RELY_ID)
		<foreach collection="list" item="resourceRely" open="VALUES(" separator="),(" close=")">#{resourceRely.id},#{resourceRely.relyId}</foreach>
	</insert>
	
	<select id="findResource" resultMap="resource" parameterType="int">
		SELECT * FROM RESOURCE AS R WHERE R.ID = #{id}
	</select>
	
	<select id="findLabelVersion" resultMap="resource" parameterType="String">
		SELECT R.ID,R.VERSION_NUMBER FROM RESOURCE AS R WHERE R.LABEL = #{label}
	</select>
	
	<select id="findAllResource" resultMap="resource">
		SELECT * FROM RESOURCE
	</select>
	
	<select id="findRelyResource" resultMap="resource" parameterType="Map">
		SELECT * FROM RESOURCE_RELY AS RR LEFT JOIN RESOURCE AS R ON RR.ID = R.ID WHERE RR.RELY_ID = #{relyId}
		AND <foreach collection="ids" item="id" open="RR.ID NOT IN(" separator="," close=")">#{id}</foreach>
	</select>
	
	<select id="findSonResourceList" resultMap="resource" parameterType="int">
		SELECT * FROM RESOURCE AS R WHERE R.PARENT_ID = #{id}
	</select>
	
	<select id="findSonResource" resultMap="resource_tree" parameterType="int">
		SELECT * FROM RESOURCE AS R WHERE R.PARENT_ID = #{ID}
	</select>
	
	<select id="isExistTable" resultType="int" parameterType="String">
		SELECT COUNT(0) FROM SYS.SYSTABLES AS ST WHERE ST.TABLENAME = #{tableName}
	</select>
	
	<select id="isExistLabel" resultType="int" parameterType="String">
		SELECT COUNT(0) FROM RESOURCE AS R WHERE R.LABEL = #{label}
	</select>
	
	<update id="updateResourceLabel" parameterType="Map">
		UPDATE RESOURCE AS R SET R.LABEL = #{label} WHERE R.ID = #{id}
	</update>
	
	<update id="updateResourceVersions" parameterType="org.wang.chuangen.webvs.model.Resource">
		UPDATE RESOURCE AS R SET R.VERSION_NUMBER = #{versionNumber},R.UPDATE_TIME = #{updateTime} WHERE R.ID = #{id}
	</update>
	
	<update id="createResourceTable">
		CREATE TABLE RESOURCE(
			ID INT GENERATED BY DEFAULT AS IDENTITY,
			PARENT_ID INT,
			URL VARCHAR(256),
			URL_TYPE VARCHAR(16),
			FILE_NAME VARCHAR(32),
			LABEL VARCHAR(32),
			VERSION_NUMBER INT,
			UPDATE_TIME BIGINT,
			CONSTRAINT P_KEY_1 PRIMARY KEY(ID)
		)
	</update>
	
	<update id="createUrlIndex">
		 CREATE INDEX URL_INDEX ON RESOURCE(URL)
	</update>
	
	<update id="createResourceRelyTable">
		CREATE TABLE RESOURCE_RELY(
			ID INT,
			RELY_ID INT,
			CONSTRAINT P_KEY_2 PRIMARY KEY(ID,RELY_ID)
		)
	</update>
	
	<delete id="deleteResourceByIds" parameterType="List">
		DELETE FROM RESOURCE WHERE
		<foreach collection="list" item="id" open="ID IN(" separator="," close=")">#{id}</foreach>
	</delete>
	
	<delete id="deleteRelyByIds" parameterType="List">
		DELETE FROM RESOURCE_RELY WHERE
		<foreach collection="list" item="id" open="ID IN(" separator="," close=")">#{id}</foreach>
		OR 
		<foreach collection="list" item="id" open="RELY_ID IN(" separator="," close=")">#{id}</foreach>
	</delete>
	
	<delete id="deleteResourceRelyByIds" parameterType="List">
		DELETE FROM RESOURCE_RELY WHERE
		<foreach collection="list" item="id" open="ID IN(" separator="," close=")">#{id}</foreach>
	</delete>
	
	<delete id="deleteTable" parameterType="Map">
		DROP TABLE ${tableName}
	</delete>
</mapper>